# Dockerfile for Model Gate System v2
# Build: docker build -f Dockerfile.gate -t loc-mvr:gate_v2 .
# Run:   docker run --rm -it loc-mvr:gate_v2 python scripts/run_dual_gates.py --models ...

FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements first for layer caching
COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

# Copy project files
COPY scripts/ ./scripts/
COPY config/ ./config/

# Copy essential data files only
COPY data/gate_sample.csv ./data/
COPY data/reality_gate_v1.csv ./data/
COPY data/empty_gate_v1.csv ./data/
COPY data/empty_gate_v2.csv ./data/
COPY data/empty_gate_v3_mixed.csv ./data/
COPY data/reality_gate_v1.meta.json ./data/
COPY data/empty_gate_v3_mixed.meta.json ./data/
COPY data/empty_gate_v4_batch.csv ./data/
COPY data/empty_gate_v4_batch.meta.json ./data/
COPY data/draft.csv ./data/
COPY data/attachment/ ./data/attachment/

# Set environment variables for API credentials (embedded in image)
# Note: File paths point to locations inside the container
ENV GATE_IMAGE_TAG=gate_v2
ENV LLM_API_KEY_FILE=/app/data/attachment/api_key.txt
ENV LLM_ACCESS_TOKEN_FILE=/app/data/attachment/api_access_token.txt
ENV LLM_BASE_URL=https://api.apiyi.com/v1
ENV LLM_TRACE_PATH=/app/data/llm_trace_gate.jsonl

# Create reports directory
RUN mkdir -p /app/reports

# Default command
CMD ["python", "scripts/run_dual_gates.py", "--help"]
