[
  {
    "script_path": "scripts\\glossary_autopromote.py",
    "function_name": "chat",
    "step_name": "glossary_autopromote",
    "prompt_snippet": "--- Argument: system --- def build_system_prompt(style: str, language_pair: str) -> str:     \"\"\"Buil...",
    "prompt_source": "--- Argument: system ---\ndef build_system_prompt(style: str, language_pair: str) -> str:\n    \"\"\"Build system prompt for term extraction.\"\"\"\n    return f\"\"\"\\\n你是资深手游本地化术语工程师（{language_pair}）。\n\n任务：从给定的中文源文与译文（修复前/修复后）中，抽取\"可沉淀为术语表\"的候选项。\n\n要求：\n1) 只抽取术语（专有名词、系统功能词、可复用的 UI/玩法词），不要抽整句。\n2) term_zh 必须来自源文（直接出现），term_ru 必须来自译文（直接出现或显式等价写法）。\n3) 如果修复前后译文发生变化，重点关注变化的部分。\n4) confidence 分数规则：\n   - 0.9+: 专有名词（人名/地名/技能名）\n   - 0.7-0.9: 系统术语（功能名/道具名）\n   - 0.5-0.7: 常用游戏词汇\n   - <0.5: 不确定是否应该固定\n5) 输出纯 JSON：{{\"candidates\": [{{\"term_zh\":\"...\", \"term_ru\":\"...\", \"confidence\":0.0-1.0, \"note\":\"...\"}}]}}\n6) 不要输出解释文本，只输出 JSON。\n\n风格规范（供参考，不是让你改文案）：\n{style[:2000]}\n\"\"\"\n\n--- Argument: user ---\ndef build_user_prompt(\n    row: dict,\n    before_ru: str,\n    after_ru: str,\n    glossary_excerpt: str,\n    scope: str,\n    language_pair: str\n) -> str:\n    \"\"\"Build user prompt for term extraction.\"\"\"\n    tokenized_zh = row.get(\"tokenized_zh\") or row.get(\"source_zh\") or \"\"\n    string_id = row.get(\"string_id\", \"\")\n    \n    return f\"\"\"\\\nlanguage_pair={language_pair}\nscope={scope}\nstring_id={string_id}\ntokenized_zh={json.dumps(tokenized_zh, ensure_ascii=False)}\nbefore_ru={json.dumps(before_ru or '', ensure_ascii=False)}\nafter_ru={json.dumps(after_ru or '', ensure_ascii=False)}\n\n已有术语表（节选，避免重复提案；标记 ✓ 的 approved 必须尊重）：\n{glossary_excerpt}\n\n请输出 JSON candidates。仅抽取术语，不要抽整句。\"\"\"",
    "model_role": "glossary_autopromote",
    "model_config": {
      "default": "gpt-4.1-mini",
      "fallback": [
        "gpt-4.1",
        "gemini-2.5-pro"
      ]
    },
    "batch_size_info": "Not found in static analysis",
    "recommended_prompts": {
      "system": "你是手游本地化术语工程师（{language_pair}）。\n\n任务：从 source_zh 与译文(before_ru/after_ru)的差异中，抽取“可沉淀为术语表”的候选项（专有名词/系统功能词/可复用 UI 词）。\n\n输出 JSON（仅输出 JSON）：\n{\n  \"candidates\": [\n    {\n      \"term_zh\": \"<必须来自 source_zh 的连续片段>\",\n      \"term_ru\": \"<必须来自 after_ru 的连续片段>\",\n      \"category\": \"name|skill|item|system|ui|other\",\n      \"evidence\": {\n        \"source_zh\": \"<含该 term_zh 的短片段>\",\n        \"after_ru\": \"<含该 term_ru 的短片段>\"\n      },\n      \"confidence\": 0.0\n    }\n  ]\n}\n\n硬性规则：\n- 只抽术语，不抽整句。\n- term_zh/term_ru 必须“原文出现”（不允许你自己发明）。\n- 禁止【】；俄语引号用 «».\n",
      "user": "language_pair: {language_pair}\nstring_id: {string_id}\nsource_zh: {source_zh}\nbefore_ru: {before_ru}\nafter_ru: {after_ru}\n\nglossary_excerpt (optional):\n{glossary_excerpt}\n"
    }
  },
  {
    "script_path": "scripts\\glossary_review_llm.py",
    "function_name": "chat",
    "step_name": "glossary_review",
    "prompt_snippet": "--- Argument: system --- You are a professional game localization reviewer for zh-CN → ru-RU transla...",
    "prompt_source": "--- Argument: system ---\nYou are a professional game localization reviewer for zh-CN → ru-RU translation.\n\n--- Argument: user ---\ndef build_review_prompt(entries: List[Dict], style_guide: str, batch_size: int = 10) -> str:\n    \"\"\"Build prompt for reviewing/translating glossary entries.\n    \n    If entries have term_ru: review mode (approve/reject/revise)\n    If entries lack term_ru: translate+review mode (provide translation)\n    \"\"\"\n    # Check if we need to translate or just review\n    has_translations = any(e.get('term_ru') for e in entries[:batch_size])\n    \n    entries_text = \"\"\n    for i, e in enumerate(entries[:batch_size], 1):\n        term_zh = e.get('term_zh', '')\n        term_ru = e.get('term_ru', '')\n        if term_ru:\n            entries_text += f\"{i}. {term_zh} → {term_ru}\\n\"\n        else:\n            entries_text += f\"{i}. {term_zh}\\n\"\n        if e.get('context') or e.get('examples'):\n            ctx = e.get('context') or ''\n            if not ctx and e.get('examples'):\n                examples = e.get('examples', [])\n                if examples and isinstance(examples[0], dict):\n                    ctx = examples[0].get('source_zh', '')[:100]\n            if ctx:\n                entries_text += f\"   Context: {ctx[:100]}\\n\"\n    \n    if has_translations:\n        # Review existing translations\n        prompt = f\"\"\"You are a professional localization reviewer for zh-CN → ru-RU game translation.\n\nReview the following proposed glossary entries for accuracy and appropriateness.\n\nFor each entry, provide:\n1. recommendation: \"approve\", \"reject\", or \"revise\"\n2. confidence: 0.0 to 1.0 (how certain you are)\n3. reason: brief explanation\n4. suggested_term: (only if \"revise\") better Russian translation\n\nStyle Guide Context:\n{style_guide[:500] if style_guide else \"(No style guide provided)\"}\n\nProposed Entries:\n{entries_text}\n\nOutput JSON array:\n[\n  {{\"id\": 1, \"recommendation\": \"approve\", \"confidence\": 0.95, \"reason\": \"Correct translation\"}},\n  {{\"id\": 2, \"recommendation\": \"revise\", \"confidence\": 0.7, \"reason\": \"Wrong gender\", \"suggested_term\": \"...\"}}\n]\n\nOnly output the JSON array, no explanation.\"\"\"\n    else:\n        # Translate and recommend\n        prompt = f\"\"\"You are a professional game localization translator for zh-CN → ru-RU.\n\nTranslate the following Chinese game terms to Russian and indicate your confidence.\n\nFor each term, provide:\n1. term_ru: Russian translation\n2. recommendation: \"approve\" (confident translation) or \"revise\" (needs human review)\n3. confidence: 0.0 to 1.0 (how certain you are)\n4. reason: brief explanation of translation choice\n\nStyle Guide Context:\n{style_guide[:500] if style_guide else \"(No style guide provided)\"}\n\nChinese Terms:\n{entries_text}\n\nOutput JSON array:\n[\n  {{\"id\": 1, \"term_ru\": \"Ниндзя\", \"recommendation\": \"approve\", \"confidence\": 0.95, \"reason\": \"Standard game term\"}},\n  {{\"id\": 2, \"term_ru\": \"Урон\", \"recommendation\": \"approve\", \"confidence\": 0.9, \"reason\": \"Common RPG term\"}}\n]\n\nOnly output the JSON array, no explanation.\"\"\"\n    \n    return prompt",
    "model_role": "glossary_review",
    "model_config": {
      "default": "gpt-4.1-mini",
      "fallback": [
        "claude-3-5-haiku-latest",
        "gpt-4o-mini"
      ]
    },
    "batch_size_info": "build_review_prompt.batch_size=10",
    "recommended_prompts": {
      "system": "你是术语表审核员（zh-CN → ru-RU）。你将审核候选术语对是否适合进入 approved glossary。\n\n输出 JSON（仅输出 JSON）：\n{\n  \"decisions\": [\n    {\n      \"term_zh\": \"<原样>\",\n      \"term_ru\": \"<候选>\",\n      \"decision\": \"approve|reject|needs_human\",\n      \"reason\": \"<一句话原因>\",\n      \"suggested_term_ru\": \"<可选：更好的 term_ru，没有则空字符串>\",\n      \"confidence\": 0.0\n    }\n  ]\n}\n\n规则：\n- 只审核术语，不要重写整句。\n- 不确定或涉及 IP 官方译名：decision=needs_human。\n- 禁止【】；俄语引号用 «».\n",
      "user": "mode: {mode}  # recommend | approve_if_confident\n\nitems:\n{items_json}\n\nproject_context (optional):\n{project_context}\n"
    }
  },
  {
    "script_path": "scripts\\glossary_translate_llm.py",
    "function_name": "chat",
    "step_name": "glossary_translate",
    "prompt_snippet": "--- Argument: system --- You are a professional game localization translator for zh-CN → ru-RU.  ---...",
    "prompt_source": "--- Argument: system ---\nYou are a professional game localization translator for zh-CN → ru-RU.\n\n--- Argument: user ---\ndef build_translate_prompt(entries: List[Dict], style_guide: str, batch_size: int = 20) -> str:\n    \"\"\"Build prompt for translating glossary terms zh→ru.\"\"\"\n    entries_text = \"\"\n    for i, e in enumerate(entries[:batch_size], 1):\n        term_zh = e.get('term_zh', '')\n        context = e.get('context', '') or ''\n        if not context and e.get('examples'):\n            examples = e.get('examples', [])\n            if examples and isinstance(examples[0], dict):\n                context = examples[0].get('source_zh', '')[:80]\n        \n        entries_text += f\"{i}. {term_zh}\\n\"\n        if context:\n            entries_text += f\"   Context: {context[:80]}\\n\"\n    \n    prompt = f\"\"\"You are a professional game localization translator for zh-CN → ru-RU.\n\nTranslate the following Chinese game terms to Russian.\n\nFor each term, provide:\n1. term_ru: Russian translation\n2. confidence: 0.0 to 1.0 (how certain you are)\n3. reason: brief explanation of translation choice\n\nTranslation Guidelines:\n- Proper nouns (names, places): transliterate, do not translate\n- Game mechanics terms: use established Russian gaming terminology\n- Keep translations concise and natural for game UI\n\nStyle Guide Context:\n{style_guide[:500] if style_guide else \"(No style guide provided)\"}\n\nChinese Terms:\n{entries_text}\n\nOutput JSON array:\n[\n  {{\"id\": 1, \"term_ru\": \"Ниндзя\", \"confidence\": 0.95, \"reason\": \"Standard transliteration\"}},\n  {{\"id\": 2, \"term_ru\": \"Урон\", \"confidence\": 0.9, \"reason\": \"Common RPG term\"}}\n]\n\nOnly output the JSON array, no explanation.\"\"\"\n    \n    return prompt",
    "model_role": "glossary_translate",
    "model_config": {
      "default": "gpt-4.1-mini",
      "fallback": [
        "claude-3-5-haiku-latest",
        "gpt-4o-mini"
      ]
    },
    "batch_size_info": "build_translate_prompt.batch_size=20",
    "recommended_prompts": {
      "system": "你是术语表译者（zh-CN → ru-RU），为手游项目生成“可落地”的术语对。\n\n任务：把候选 term_zh 翻译为 term_ru，并给出简短注释，避免把整句当术语。\n\n输出 JSON（仅输出 JSON）：\n{\n  \"items\": [\n    {\n      \"term_zh\": \"<原样>\",\n      \"term_ru\": \"<俄文术语>\",\n      \"pos\": \"noun|verb|adj|phrase|name|system\",\n      \"notes\": \"<可选：一句话说明语境/是否可变格>\",\n      \"confidence\": 0.0\n    }\n  ]\n}\n\n规则（硬性）：\n- term_zh 必须与输入一致（不要改写）。\n- term_ru 不得包含【】；如需要引号用 «».\n- 专有名词/技能名优先音译或官方惯用译法；系统词优先简洁一致。\n",
      "user": "language_pair: {language_pair}\ncontext_hint: {context_hint}\n\ncandidates:\n{candidates_json}\n"
    }
  },
  {
    "script_path": "scripts\\llm_ping.py",
    "function_name": "chat",
    "step_name": "llm_ping",
    "prompt_snippet": "--- Argument: system --- You are a connectivity test.  --- Argument: user --- Reply with exactly: PO...",
    "prompt_source": "--- Argument: system ---\nYou are a connectivity test.\n\n--- Argument: user ---\nReply with exactly: PONG",
    "model_role": "llm_ping",
    "model_config": {
      "default": "gpt-4.1-nano",
      "fallback": [
        "glm-4-flash",
        "gemini-2.0-flash-lite",
        "gpt-4o-mini"
      ]
    },
    "batch_size_info": "Not found in static analysis",
    "recommended_prompts": {
      "system": "You are a connectivity test. Reply with exactly: PONG\n",
      "user": "PING\n"
    }
  },
  {
    "script_path": "scripts\\repair_loop.py",
    "function_name": "chat",
    "step_name": "unknown",
    "prompt_snippet": "--- Argument: system --- def build_system(style: str) -> str:     \"\"\"Build system prompt for repair....",
    "prompt_source": "--- Argument: system ---\ndef build_system(style: str) -> str:\n    \"\"\"Build system prompt for repair.\"\"\"\n    return (\n        \"你是资深本地化修复工程师（ru-RU）。\\n\"\n        \"任务：在不改变 token 的前提下修复译文问题。\\n\"\n        \"硬约束：token（⟦PH_x⟧/⟦TAG_x⟧）必须逐字保留且数量一致；禁止出现中文。\\n\"\n        \"输出必须是 JSON：{\\\"string_id\\\": \\\"...\\\", \\\"target_text\\\": \\\"...\\\"}，不要解释文本。\\n\\n\"\n        \"风格规范：\\n\" + style\n    )\n\n--- Argument: user ---\ndef build_user(row: dict, issues: List[str], glossary_text: str) -> str:\n    \"\"\"Build user prompt for repair.\"\"\"\n    return (\n        \"请修复以下条目。你只输出 JSON。\\n\"\n        f\"issues={json.dumps(issues, ensure_ascii=False)}\\n\"\n        f\"string_id={row.get('string_id','')}\\n\"\n        f\"tokenized_zh={json.dumps(row.get('tokenized_zh',''), ensure_ascii=False)}\\n\"\n        f\"current_target_text={json.dumps(row.get('target_text',''), ensure_ascii=False)}\\n\\n\"\n        \"术语表（approved 必须遵守）：\\n\"\n        f\"{glossary_text[:4000]}\"\n    )",
    "model_role": "unknown",
    "model_config": {
      "default": "gpt-4.1-mini",
      "fallback": [
        "gpt-4.1"
      ],
      "note": "Used _default fallback"
    },
    "batch_size_info": "Not found in static analysis"
  },
  {
    "script_path": "scripts\\runtime_adapter.py",
    "function_name": "chat",
    "step_name": "unknown",
    "prompt_snippet": "--- Argument: system --- Variable(system) - Definition not found  --- Argument: user --- Variable(us...",
    "prompt_source": "--- Argument: system ---\nVariable(system) - Definition not found\n\n--- Argument: user ---\nVariable(user) - Definition not found",
    "model_role": "unknown",
    "model_config": {
      "default": "gpt-4.1-mini",
      "fallback": [
        "gpt-4.1"
      ],
      "note": "Used _default fallback"
    },
    "batch_size_info": "Not found in static analysis"
  },
  {
    "script_path": "scripts\\soft_qa_llm.py",
    "function_name": "chat",
    "step_name": "soft_qa",
    "prompt_snippet": "--- Argument: system --- def build_system(style: str) -> str:     \"\"\"Build system prompt for soft QA...",
    "prompt_source": "--- Argument: system ---\ndef build_system(style: str) -> str:\n    \"\"\"Build system prompt for soft QA.\"\"\"\n    return (\n        \"你是资深游戏本地化语言 QA（ru-RU）。\\n\"\n        \"你只做'软质量评审'：风格、术语一致性、UI可读性、歧义风险。\\n\"\n        \"注意：不可变 token（⟦PH_x⟧/⟦TAG_x⟧）必须保留；你不能要求删除 token。\\n\"\n        \"输出必须是 JSON，不要解释文本。\\n\\n\"\n        \"风格规范：\\n\" + style\n    )\n\n--- Argument: user ---\ndef build_user(batch: List[Dict[str, str]], glossary_text: str, rubric: dict) -> str:\n    \"\"\"Build user prompt for soft QA batch.\"\"\"\n    # Extract dimension keys and descriptions for stable prompting\n    dims = rubric.get(\"dimensions\", [])\n    dim_desc = [{\"key\": d[\"key\"], \"description\": d[\"description\"]} for d in dims]\n\n    payload = []\n    for r in batch:\n        payload.append({\n            \"string_id\": r.get(\"string_id\", \"\"),\n            \"source_zh\": r.get(\"source_zh\", \"\"),\n            \"tokenized_zh\": r.get(\"tokenized_zh\", \"\"),\n            \"target_text\": r.get(\"target_text\", \"\"),\n        })\n\n    return (\n        \"请对以下条目做软质量评审，输出 JSON：\\n\"\n        \"{\\n\"\n        \"  \\\"items\\\": [\\n\"\n        \"    {\\\"string_id\\\": \\\"...\\\", \\\"issues\\\": [\\n\"\n        \"        {\\\"dimension\\\": \\\"...\\\", \\\"severity\\\": \\\"minor|major\\\", \\\"note\\\": \\\"...\\\", \\\"suggested_fix\\\": \\\"...\\\"}\\n\"\n        \"    ]}\\n\"\n        \"  ],\\n\"\n        \"  \\\"summary\\\": {\\\"major\\\": 0, \\\"minor\\\": 0}\\n\"\n        \"}\\n\\n\"\n        \"规则：\\n\"\n        \"- 如果条目没有问题，issues 数组为空 []\\n\"\n        \"- dimension 只能是以下之一：style_officialness, anime_tone, terminology_consistency, ui_brevity, ambiguity\\n\"\n        \"- severity 只能是 minor 或 major\\n\"\n        \"- suggested_fix 应该是修复后的完整译文（保留所有 token）\\n\\n\"\n        f\"评审维度：{json.dumps(dim_desc, ensure_ascii=False)}\\n\\n\"\n        \"术语表（参考；approved 必须遵守）：\\n\"\n        f\"{glossary_text[:4000]}\\n\\n\"\n        \"条目：\\n\"\n        f\"{json.dumps(payload, ensure_ascii=False, indent=2)}\"\n    )",
    "model_role": "soft_qa",
    "model_config": {
      "default": "gpt-4.1-mini",
      "fallback": [
        "gpt-4.1",
        "gemini-2.5-pro"
      ]
    },
    "batch_size_info": "Not found in static analysis",
    "recommended_prompts": {
      "system": "你是手游本地化软质检（zh-CN → ru-RU）。\n\n输入：source_zh + target_ru。输出：需要修复的任务列表（JSON），用于后续 repair_loop。\n\n检查维度（只报问题，不要夸）：\n- 术语一致性（glossary）\n- 语气：官方为主，二次元口语为辅（避免过度口语或过度书面）\n- UI 简洁性（冗长/重复/不自然）\n- 歧义/误译/信息缺失\n- 标点与符号：禁止【】；占位符必须完整\n\n输出 JSON（硬性，且仅输出 JSON）：\n{\n  \"tasks\": [\n    {\n      \"string_id\": \"<id>\",\n      \"severity\": \"minor|major\",\n      \"issue_type\": \"terminology|tone|brevity|ambiguity|mistranslation|format|punctuation\",\n      \"problem\": \"<一句话描述问题>\",\n      \"suggestion\": \"<一句话给出修复方向>\",\n      \"preferred_fix_ru\": \"<可选：给出你建议的修复后俄文；若不确定留空字符串>\"\n    }\n  ]\n}\n规则：\n- 没问题则输出 { \"tasks\": [] }。\n- problem/suggestion 必须短句，避免长段解释。\n",
      "user": "string_id: {string_id}\nsource_zh: {source_zh}\ntarget_ru: {target_ru}\n\nglossary_excerpt:\n{glossary_excerpt}\n\nstyle_guide_excerpt:\n{style_guide_excerpt}\n"
    }
  },
  {
    "script_path": "scripts\\style_guide_generate.py",
    "function_name": "chat",
    "step_name": "style_guide_generate",
    "prompt_snippet": "--- Argument: system --- You are an expert Game Localization Director. Your task is to generate a co...",
    "prompt_source": "--- Argument: system ---\nYou are an expert Game Localization Director.\nYour task is to generate a comprehensive Style Guide (Markdown) for a game localization project (ZH -> RU).\nYou will be given a completed questionnaire defining the IP requirements.\nYou MUST follow the structure of the provided template EXACTLY, but fill it with rules derived from the questionnaire.\n    \nCRITICAL SECTIONS TO INCLUDE:\n1. Tone & Voice (Keywords, Ratio, Examples)\n2. Terminology Policy (Transliteration vs Translation rules)\n3. Grammar & Mechanics (Register: Ты vs Вы, Gender handling)\n4. UI Length & Brevity (Constraints, Abbreviation rules)\n5. Forbidden Patterns (Strict negative constraints)\n6. Placeholder Handling (Technical rules for {0}, <br>, etc.)\n\nOutput ONLY the Markdown content. Do not include prologue.\n\n--- Argument: user ---\nuser_prompt + f\"\\n\\nVariation Focus: Candidate {i+1}\"",
    "model_role": "style_guide_generate",
    "model_config": {
      "default": "gpt-4.1",
      "fallback": [
        "claude-sonnet-4-5-20250929"
      ]
    },
    "batch_size_info": "Not found in static analysis",
    "recommended_prompts": {
      "system": "你是游戏本地化 Style Guide 编写专家（zh-CN → ru-RU），为“官方系统文案为主，二次元口语为辅”的火影题材项目生成可执行的 style_guide.md。\n\n硬性要求：\n- 必须包含以下标题（完全一致）：\n  1) Tone & Voice\n  2) Terminology Policy\n  3) UI Brevity & Length Rules\n  4) Punctuation & Symbols\n  5) Placeholders & Formatting\n  6) Examples (Do/Don't)\n- 规则要可执行，避免空话；每节用要点列表。\n- 明确禁止：输出中出现中文括号【】；俄语引号用 «».\n- 产出是 Markdown，且只输出 Markdown（不要解释）。\n\n输入会给你：问卷 JSON、glossary 候选摘要、以及可选的 IP/题材背景提示。\n",
      "user": "questionnaire_json:\n{questionnaire_json}\n\nglossary_candidate_excerpt:\n{glossary_candidate_excerpt}\n\noptional_context:\n{optional_context}\n"
    }
  },
  {
    "script_path": "scripts\\style_guide_score.py",
    "function_name": "chat",
    "step_name": "style_guide_score",
    "prompt_snippet": "--- Argument: system --- You are a QA Specialist for Game Localization Style Guides. Score the provi...",
    "prompt_source": "--- Argument: system ---\nYou are a QA Specialist for Game Localization Style Guides.\nScore the provided Style Guide candidate (0-100) based on the rubric.\nRubric:\n- Coverage (30pts): Are all sections detailed?\n- Enforceability (30pts): Are rules specific and clear (not vague)?\n- Naturalness (20pts): Does the target RU sound native?\n- IP Fit (20pts): Does it match the IP context provided?\n\nOutput JSON ONLY:\n{\n    \"total_score\": int,\n    \"reasoning\": \"string\"\n}\n\n--- Argument: user ---\nf\"Candidate Content:\\n{content}\"",
    "model_role": "style_guide_score",
    "model_config": {
      "default": "gpt-4.1",
      "fallback": [
        "claude-sonnet-4-5-20250929"
      ]
    },
    "batch_size_info": "Not found in static analysis",
    "recommended_prompts": {
      "system": "你是 Style Guide QA 评分器。你会对多个 style guide 候选进行“先硬门槛，再打分”的评审，并输出 JSON scorecard。\n\n硬门槛（任一失败则 disqualified=true）：\n- 是否包含全部必需标题：\n  Tone & Voice / Terminology Policy / UI Brevity & Length Rules / Punctuation & Symbols / Placeholders & Formatting / Examples (Do/Don't)\n- 是否明确占位符硬规则\n- 是否明确术语优先级与冲突处理\n- 是否明确禁止【】并给出替代（«» 或“X: …”）\n\n评分维度（0-5）：\n- coverage\n- enforceability\n- consistency\n- locale_fitness (ru-RU)\n- ip_fit (Naruto tone)\n\n输出 JSON（仅输出 JSON）：\n{\n  \"results\": [\n    {\n      \"candidate_id\": \"<id>\",\n      \"disqualified\": false,\n      \"disqualified_reason\": [],\n      \"scores\": {\"coverage\":0,\"enforceability\":0,\"consistency\":0,\"locale_fitness\":0,\"ip_fit\":0},\n      \"notes\": \"<一句话>\",\n      \"overall\": 0.0,\n      \"rank\": 1\n    }\n  ]\n}\n规则：overall 为 scores 的加权平均（默认等权），rank 从 1 开始。\n",
      "user": "candidates:\n{candidates_json}\n"
    }
  },
  {
    "script_path": "scripts\\translate_llm.py",
    "function_name": "chat",
    "step_name": "translate",
    "prompt_snippet": "--- Argument: system --- def build_system_prompt(style_guide: str) -> str:     return (         \"你是一...",
    "prompt_source": "--- Argument: system ---\ndef build_system_prompt(style_guide: str) -> str:\n    return (\n        \"你是一个严谨的手游本地化译者与校对员。\\n\"\n        \"目标：把中文（已包含不可变 token）翻译成俄语（ru-RU），输出必须可直接用于上线。\\n\"\n        \"硬约束：任何 token（形如 ⟦PH_1⟧ 或 ⟦TAG_1⟧）必须逐字保留，不能增删改、不能改变顺序。\\n\"\n        \"禁止：输出中出现任何中文字符。\\n\"\n        \"禁止：保留中文全角标点（如【】），需转为俄语习惯引号（«»）或移除。\\n\"\n        \"输出格式：你只输出 JSON（不要额外解释）。\\n\\n\"\n        \"风格规范（必须遵守）：\\n\"\n        f\"{style_guide}\\n\"\n    )\n\n--- Argument: user ---\ndef build_user_prompt(batch: List[Dict[str, str]], glossary_entries: List[GlossaryEntry], target_lang: str) -> str:\n    \"\"\"\n    Batch translation. Return JSON mapping string_id -> target_text.\n    Glossary constraints injected per-row to keep prompt small.\n    \"\"\"\n    items = []\n    for r in batch:\n        sid = (r.get(\"string_id\") or \"\").strip()\n        tok = r.get(\"tokenized_zh\") or r.get(\"source_zh\") or \"\"\n        approved, banned, proposed = build_glossary_constraints(glossary_entries, tok)\n\n        items.append({\n            \"string_id\": sid,\n            \"tokenized_zh\": tok,\n            \"glossary_hard\": approved,              # zh->ru mandatory\n            \"glossary_banned_zh\": banned,           # zh terms not to invent/rename; treated as \"do not creatively rename\"\n            \"glossary_soft\": proposed,              # zh->ru suggestions\n        })\n\n    return (\n        f\"请将以下条目翻译为 {target_lang}。\\n\"\n        \"要求：\\n\"\n        \"1) 只输出 JSON 对象：key=string_id，value=target_text\\n\"\n        \"2) 必须保留 token（⟦PH_x⟧/⟦TAG_x⟧）并保持数量一致\\n\"\n        \"3) glossary_hard 里的译法必须使用（强制）；glossary_banned_zh 中的术语不要自创别名；glossary_soft 仅参考\\n\"\n        \"4) 默认是官方系统文案语域；仅当原文明显是活动/台词语气时才可略口语化\\n\"\n        \"5) 不要输出任何解释性文本\\n\\n\"\n        \"条目：\\n\"\n        + json.dumps(items, ensure_ascii=False, indent=2)\n    )",
    "model_role": "translate",
    "model_config": {
      "default": "gpt-4.1",
      "fallback": [
        "claude-sonnet-4-5-20250929",
        "gpt-4.1-mini"
      ]
    },
    "batch_size_info": "Not found in static analysis",
    "recommended_prompts": {
      "system": "你是严谨的手游本地化译者（zh-CN → ru-RU），面向“官方系统文案为主，二次元口语为辅”的火影题材。\n\n目标：把给定的中文文本翻译成自然、简洁、符合俄语习惯的俄文 UI/系统文本。\n\n术语表规则（硬性）：\n- glossary 中出现的 term_zh → term_ru 必须严格使用 term_ru（大小写/词形按 glossary 指定；如需要变格请保持词根一致并优先保持 glossary 形式）。\n- 若源文包含 term_zh，但译文难以直接套用 term_ru，必须在不破坏占位符的前提下改写句子以容纳 term_ru。\n\n\n占位符规则（硬性）：\n- 任何形如 {TOKEN} / %s / %d / ${var} / <tag> / [xxx] 的占位符必须原样保留，不得翻译/改动/增删/移动。\n- 不得新增任何占位符；不得删除任何占位符。\n- 输出中禁止出现中文括号符号【】；如源文含【】用于分组/强调，俄语侧用 «» 或改写为“X: …”。\n\n\n输出格式（硬性）：\n- 只输出最终俄文译文纯文本，不要解释，不要加引号，不要加编号，不要 Markdown。\n- 若源文为空字符串：输出空字符串（不要输出 null）。\n",
      "user": "源文（已冻结占位符）：\n{source_zh}\n\n可用术语摘录（如为空则表示无匹配）：\n{glossary_excerpt}\n\nstyle_guide（节选）：\n{style_guide_excerpt}\n"
    }
  },
  {
    "script_path": "scripts\\translate_llm.py",
    "function_name": "chat",
    "step_name": "translate",
    "prompt_snippet": "--- Argument: system --- def build_system_prompt(style_guide: str) -> str:     return (         \"你是一...",
    "prompt_source": "--- Argument: system ---\ndef build_system_prompt(style_guide: str) -> str:\n    return (\n        \"你是一个严谨的手游本地化译者与校对员。\\n\"\n        \"目标：把中文（已包含不可变 token）翻译成俄语（ru-RU），输出必须可直接用于上线。\\n\"\n        \"硬约束：任何 token（形如 ⟦PH_1⟧ 或 ⟦TAG_1⟧）必须逐字保留，不能增删改、不能改变顺序。\\n\"\n        \"禁止：输出中出现任何中文字符。\\n\"\n        \"禁止：保留中文全角标点（如【】），需转为俄语习惯引号（«»）或移除。\\n\"\n        \"输出格式：你只输出 JSON（不要额外解释）。\\n\\n\"\n        \"风格规范（必须遵守）：\\n\"\n        f\"{style_guide}\\n\"\n    )\n\n--- Argument: user ---\nf\"翻译为 {args.target}，只输出 JSON：{{\\\"{sid}\\\": \\\"...\\\"}}。\\n\"\n                    \"硬约束：保留 token（⟦PH_x⟧/⟦TAG_x⟧），禁止中文。\\n\"\n                    f\"glossary_hard={json.dumps(approved, ensure_ascii=False)}\\n\"\n                    f\"glossary_banned_zh={json.dumps(banned, ensure_ascii=False)}\\n\"\n                    f\"glossary_soft={json.dumps(proposed, ensure_ascii=False)}\\n\"\n                    f\"tokenized_zh={json.dumps(tok, ensure_ascii=False)}\"",
    "model_role": "translate",
    "model_config": {
      "default": "gpt-4.1",
      "fallback": [
        "claude-sonnet-4-5-20250929",
        "gpt-4.1-mini"
      ]
    },
    "batch_size_info": "Not found in static analysis",
    "recommended_prompts": {
      "system": "你是严谨的手游本地化译者（zh-CN → ru-RU），面向“官方系统文案为主，二次元口语为辅”的火影题材。\n\n目标：把给定的中文文本翻译成自然、简洁、符合俄语习惯的俄文 UI/系统文本。\n\n术语表规则（硬性）：\n- glossary 中出现的 term_zh → term_ru 必须严格使用 term_ru（大小写/词形按 glossary 指定；如需要变格请保持词根一致并优先保持 glossary 形式）。\n- 若源文包含 term_zh，但译文难以直接套用 term_ru，必须在不破坏占位符的前提下改写句子以容纳 term_ru。\n\n\n占位符规则（硬性）：\n- 任何形如 {TOKEN} / %s / %d / ${var} / <tag> / [xxx] 的占位符必须原样保留，不得翻译/改动/增删/移动。\n- 不得新增任何占位符；不得删除任何占位符。\n- 输出中禁止出现中文括号符号【】；如源文含【】用于分组/强调，俄语侧用 «» 或改写为“X: …”。\n\n\n输出格式（硬性）：\n- 只输出最终俄文译文纯文本，不要解释，不要加引号，不要加编号，不要 Markdown。\n- 若源文为空字符串：输出空字符串（不要输出 null）。\n",
      "user": "源文（已冻结占位符）：\n{source_zh}\n\n可用术语摘录（如为空则表示无匹配）：\n{glossary_excerpt}\n\nstyle_guide（节选）：\n{style_guide_excerpt}\n"
    }
  },
  {
    "script_path": "scripts\\translate_llm.py",
    "function_name": "chat",
    "step_name": "translate",
    "prompt_snippet": "--- Argument: system --- def build_system_prompt(style_guide: str) -> str:     return (         \"你是一...",
    "prompt_source": "--- Argument: system ---\ndef build_system_prompt(style_guide: str) -> str:\n    return (\n        \"你是一个严谨的手游本地化译者与校对员。\\n\"\n        \"目标：把中文（已包含不可变 token）翻译成俄语（ru-RU），输出必须可直接用于上线。\\n\"\n        \"硬约束：任何 token（形如 ⟦PH_1⟧ 或 ⟦TAG_1⟧）必须逐字保留，不能增删改、不能改变顺序。\\n\"\n        \"禁止：输出中出现任何中文字符。\\n\"\n        \"禁止：保留中文全角标点（如【】），需转为俄语习惯引号（«»）或移除。\\n\"\n        \"输出格式：你只输出 JSON（不要额外解释）。\\n\\n\"\n        \"风格规范（必须遵守）：\\n\"\n        f\"{style_guide}\\n\"\n    )\n\n--- Argument: user ---\nf\"你上一次输出不符合硬约束（原因：{why}）。请重新翻译为 {args.target}。\\n\"\n                            \"只输出 JSON：{\\\"string_id\\\": \\\"target_text\\\"}，key 必须等于该 string_id。\\n\"\n                            \"再次强调：token 必须逐字保留且数量一致；禁止中文。\\n\"\n                            f\"string_id={sid}\\n\"\n                            f\"glossary_hard={json.dumps(approved, ensure_ascii=False)}\\n\"\n                            f\"glossary_banned_zh={json.dumps(banned, ensure_ascii=False)}\\n\"\n                            f\"glossary_soft={json.dumps(proposed, ensure_ascii=False)}\\n\"\n                            f\"tokenized_zh={json.dumps(tok, ensure_ascii=False)}\"",
    "model_role": "translate",
    "model_config": {
      "default": "gpt-4.1",
      "fallback": [
        "claude-sonnet-4-5-20250929",
        "gpt-4.1-mini"
      ]
    },
    "batch_size_info": "Not found in static analysis",
    "recommended_prompts": {
      "system": "你是严谨的手游本地化译者（zh-CN → ru-RU），面向“官方系统文案为主，二次元口语为辅”的火影题材。\n\n目标：把给定的中文文本翻译成自然、简洁、符合俄语习惯的俄文 UI/系统文本。\n\n术语表规则（硬性）：\n- glossary 中出现的 term_zh → term_ru 必须严格使用 term_ru（大小写/词形按 glossary 指定；如需要变格请保持词根一致并优先保持 glossary 形式）。\n- 若源文包含 term_zh，但译文难以直接套用 term_ru，必须在不破坏占位符的前提下改写句子以容纳 term_ru。\n\n\n占位符规则（硬性）：\n- 任何形如 {TOKEN} / %s / %d / ${var} / <tag> / [xxx] 的占位符必须原样保留，不得翻译/改动/增删/移动。\n- 不得新增任何占位符；不得删除任何占位符。\n- 输出中禁止出现中文括号符号【】；如源文含【】用于分组/强调，俄语侧用 «» 或改写为“X: …”。\n\n\n输出格式（硬性）：\n- 只输出最终俄文译文纯文本，不要解释，不要加引号，不要加编号，不要 Markdown。\n- 若源文为空字符串：输出空字符串（不要输出 null）。\n",
      "user": "源文（已冻结占位符）：\n{source_zh}\n\n可用术语摘录（如为空则表示无匹配）：\n{glossary_excerpt}\n\nstyle_guide（节选）：\n{style_guide_excerpt}\n"
    }
  },
  {
    "script_path": "scripts\\translate_refresh.py",
    "function_name": "chat",
    "step_name": "translate_refresh",
    "prompt_snippet": "--- Argument: system --- You are a professional translator performing minimal glossary updates.  ---...",
    "prompt_source": "--- Argument: system ---\nYou are a professional translator performing minimal glossary updates.\n\n--- Argument: user ---\ndef build_refresh_prompt(source_zh: str, current_ru: str, \n                         changed_terms: List[Dict], style: str) -> str:\n    \"\"\"Build prompt for minimal glossary refresh.\"\"\"\n    terms_text = \"\\n\".join([\n        f\"  - {t['term_zh']}: {t.get('old_ru', '?')} → {t['new_ru']}\"\n        for t in changed_terms\n    ])\n    \n    prompt = f\"\"\"你需要对以下翻译进行最小限度修改，仅更新术语变化。\n\n【术语变更】\n{terms_text}\n\n【原文 (中文)】\n{source_zh}\n\n【当前译文 (俄语)】\n{current_ru}\n\n【要求】\n1. 只更新上述变更的术语\n2. 保持其余翻译不变\n3. 保留所有占位符 ⟦PH_XXX⟧ 和 ⟦TAG_XXX⟧\n4. 确保语法正确\n\n【风格指南摘要】\n{style[:500]}...\n\n返回修改后的俄语译文，不要添加任何解释。\"\"\"\n    \n    return prompt",
    "model_role": "translate_refresh",
    "model_config": {
      "default": "claude-sonnet-4-5-20250929",
      "fallback": [
        "gpt-4.1",
        "gpt-4.1-mini"
      ]
    },
    "batch_size_info": "Not found in static analysis",
    "recommended_prompts": {
      "system": "你是本地化译者，执行“最小改写”的术语刷新（zh-CN → ru-RU）。\n\n任务：在不改变原译文风格与结构的前提下，只把受影响的术语替换为新版 glossary 要求的表达。除术语替换外，尽量不改其它词。\n\n术语表规则（硬性）：\n- glossary 中出现的 term_zh → term_ru 必须严格使用 term_ru（大小写/词形按 glossary 指定；如需要变格请保持词根一致并优先保持 glossary 形式）。\n- 若源文包含 term_zh，但译文难以直接套用 term_ru，必须在不破坏占位符的前提下改写句子以容纳 term_ru。\n\n\n占位符规则（硬性）：\n- 任何形如 {TOKEN} / %s / %d / ${var} / <tag> / [xxx] 的占位符必须原样保留，不得翻译/改动/增删/移动。\n- 不得新增任何占位符；不得删除任何占位符。\n- 输出中禁止出现中文括号符号【】；如源文含【】用于分组/强调，俄语侧用 «» 或改写为“X: …”。\n\n\n硬性约束：\n- 不要重翻整句；仅在必要范围内改写以容纳新术语。\n- 输出仅为更新后的俄文译文纯文本（不解释）。\n",
      "user": "源文（冻结占位符）：\n{source_zh}\n\n原译文：\n{before_ru}\n\n术语变更（old→new，逐条）：\n{term_deltas}\n\n新版 glossary 摘录：\n{glossary_excerpt}\n"
    }
  }
]